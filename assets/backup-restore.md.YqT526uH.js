import{_ as e,c as t,o as s,a4 as a}from"./chunks/framework.DZXLJAMc.js";const o="/kasten-ocpv-lab/assets/01.CNIjeHVS.png",i="/kasten-ocpv-lab/assets/03.BontXkkM.png",n="/kasten-ocpv-lab/assets/04.fnTspvcu.png",l="/kasten-ocpv-lab/assets/05.DCNl8Y6n.png",r="/kasten-ocpv-lab/assets/06.BK0d08UF.png",p="/kasten-ocpv-lab/assets/07.CaHTUF-x.png",c="/kasten-ocpv-lab/assets/08.BavMi1sj.png",h="/kasten-ocpv-lab/assets/09.l7wvJ9DL.png",d="/kasten-ocpv-lab/assets/10.C72cfKD3.png",g="/kasten-ocpv-lab/assets/11.DXijJHcz.png",m="/kasten-ocpv-lab/assets/12.D65y05Bk.png",u="/kasten-ocpv-lab/assets/13.BnrOxv-E.png",k="/kasten-ocpv-lab/assets/14.BNMEnAug.png",b="/kasten-ocpv-lab/assets/15.C18m0pDs.png",v="/kasten-ocpv-lab/assets/16.C6oo3uFJ.png",f="/kasten-ocpv-lab/assets/17.D7EkATdA.png",y="/kasten-ocpv-lab/assets/18.BunpovEK.png",F="/kasten-ocpv-lab/assets/19.W3WidbtZ.png",C="/kasten-ocpv-lab/assets/20.1Zf5CRhj.png",_="/kasten-ocpv-lab/assets/21.EsKTIC2G.png",w="/kasten-ocpv-lab/assets/22.COG-Pv-c.png",B="/kasten-ocpv-lab/assets/23.Ok62OGlY.png",P="/kasten-ocpv-lab/assets/24.Bdnzsx0o.png",E="/kasten-ocpv-lab/assets/25.BQrrHbu4.png",T="/kasten-ocpv-lab/assets/26.BL6RlFdC.png",x="/kasten-ocpv-lab/assets/27.PvXHkpna.png",z=JSON.parse('{"title":"Protecting VMs","description":"","frontmatter":{},"headers":[],"relativePath":"backup-restore.md","filePath":"backup-restore.md"}'),R={name:"backup-restore.md"},A=a('<h1 id="protecting-vms" tabindex="-1">Protecting VMs <a class="header-anchor" href="#protecting-vms" aria-label="Permalink to &quot;Protecting VMs&quot;">​</a></h1><h2 id="_1-introduction" tabindex="-1">1. Introduction <a class="header-anchor" href="#_1-introduction" aria-label="Permalink to &quot;1. Introduction&quot;">​</a></h2><p>In this exercise...</p><h2 id="_2-creating-a-vm" tabindex="-1">2. Creating a VM <a class="header-anchor" href="#_2-creating-a-vm" aria-label="Permalink to &quot;2. Creating a VM&quot;">​</a></h2><ol><li><p>In the <em><strong>OpenShift Console</strong></em>, select the <em><strong>Project</strong></em> menu and click <em><strong>Create Project</strong></em>.</p><p><img src="'+o+'" alt=""></p></li><li><p>Specify <code>kasten-lab</code> as the <em><strong>Name</strong></em> and click <em><strong>Create</strong></em>.</p></li><li><p>Select <em><strong>Virtualization → Virtual Machines</strong></em> from the sidebar, and click <em><strong>Create VirtualMachine</strong></em> in the <code>kasten-lab</code> Project.</p><p><img src="'+i+'" alt=""></p></li><li><p>Under <em><strong>Template catalog</strong></em>, select the <code>fedora-server-small</code> template.</p><p><img src="'+n+'" alt=""></p></li><li><p>Update the <em><strong>VirtualMachine name</strong></em> to <code>fedora-k10</code> and click <em><strong>Quick create VirtualMachine</strong></em>.</p><p><img src="'+l+'" alt=""></p><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p></p><p>This will provision the VM with preferred storage settings for the default <code>ocs-storagecluster-ceph-rbd</code> StorageClass, specifically <em><strong>Block VolumeMode</strong></em> to provide the <em><strong>ReadWriteMany</strong></em> access required to enable live migration.</p></div></li><li><p>Validate the <code>fedora-k10</code> PersistentVolumeClaim configuration from <em><strong>Storage → PersistentVolumeClaims</strong></em> in the sidebar.</p><p><img src="'+r+`" alt=""></p></li></ol><h2 id="_3-enabling-block-mode-exports" tabindex="-1">3. Enabling Block Mode Exports <a class="header-anchor" href="#_3-enabling-block-mode-exports" aria-label="Permalink to &quot;3. Enabling Block Mode Exports&quot;">​</a></h2><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p></p><p>As some storage provisioners may not fully support Block volume mode, StorageClasses should first be evaluated for compatibility <a href="https://docs.kasten.io/latest/operating/k10tools.html#k10-primer-block-mount-check" target="_blank" rel="noreferrer">using the primer script</a>. This is skipped in the lab exercise as the <code>openshift-storage.rbd.csi.ceph.com</code> provisioner is known to be compatible.</p></div><ol><li><p>In the <em><strong>Web Terminal</strong></em>, run the following to allow the Kasten datamover to export raw Block volumes using the <code>ocs-storagecluster-ceph-rbd</code> StorageClass:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> storageclass</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ocs-storagecluster-ceph-rbd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  k10.kasten.io/sc-supports-block-mode-exports=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>Ceph RBD native API integration...</p></div></li></ol><h2 id="_4-creating-a-kasten-policy" tabindex="-1">4. Creating a Kasten Policy <a class="header-anchor" href="#_4-creating-a-kasten-policy" aria-label="Permalink to &quot;4. Creating a Kasten Policy&quot;">​</a></h2><ol><li><p>In the <em><strong>Kasten Dashboard</strong></em>, select <em><strong>Applications</strong></em> to view all discovered namespaces.</p><p><img src="`+p+'" alt=""></p><p>Your <code>kasten-lab</code> application should appear as <em><strong>Unmanaged</strong></em>, indicating it is not being protected by any policy.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p></p><p>Namespaces, including the <code>openshift-...</code> system namespaces can be excluded from the <em><strong>Applications</strong></em> list (and compliance reporting) by adding a list of <code>excludedApps</code> to the K10 Operand <code>spec</code>, as shown:</p><p><img src="'+c+'" alt=""></p><p>The following command can be used to produce a properly formatted list of namespaces beginning with <code>openshift</code> that can be copy/paste into the K10 Operand YAML tab:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ns</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-headers=true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;BEGIN { print &quot;  excludedApps:&quot; } /^openshift/{print &quot;    -&quot;,$1}&#39;</span></span></code></pre></div></div></li><li><p>Click <code>kasten-lab</code> in the <em><strong>Applications</strong></em> list to view details about the workloads and additional resources discovered within the namespace.</p><p><img src="'+h+'" alt=""></p></li><li><p>Close the <em><strong>Application Details</strong></em> window.</p></li><li><p>Under <code>kasten-lab</code>, select <em><strong>... → Create a Policy</strong></em>.</p><p><img src="'+d+'" alt=""></p></li><li><p>Leave the default <em><strong>Name</strong></em> and <em><strong>Action</strong></em>.</p><p><img src="'+g+'" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>Policy Presets provide the option of allowing administrators to define SLA-focused configurations to simplify self-service data protection for other users.</p></div></li><li><p>Leave the default <em><strong>Hourly Backup Frequency</strong></em> and <em><strong>Snapshot Retention</strong></em> values.</p><p><img src="'+m+'" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>Toggling <em><strong>Advanced Frequency Options</strong></em> allows users to specify what time hourly snapshots occur, how many snapshots to take per hour, and which snapshots should be used for daily, weekly, monthly, and yearly promotion.</p><p>Toggling <em><strong>Backup Window</strong></em> allows users to specify during what times is Kasten allowed to run the policy. Enabling <em><strong>Use Staggering</strong></em> can intelligently distribute when to start policies during the specified window such that the desired frequency is maintained, but with the least amount of policies running simultaneously, allowing Kasten to reduce the peak load on the cluster.</p><p>These settings should be left unselected for this lab.</p></div></li><li><p>Toggle <em><strong>Enable Backups via Snapshot Exports</strong></em> and select <code>ceph-rgw-immutable</code> as the <em><strong>Export Location Profile</strong></em>.</p><p><img src="'+u+'" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>By default, Kasten will export all data associated with the snapshot to ensure you have a durable, off-cluster copy. However, there are circumstances where you may only want to export references to the snapshot, such as migrating a workload in AWS from one availability zone to another. This ability to only export snapshot metadata can dramatically improve performance in these specific instances. This can be configured under <em><strong>Advanced Export Settings</strong></em>.</p></div></li><li><p>Under <em><strong>Select Applications</strong></em>, verify the <code>kasten-lab</code> namespace has been selected.</p><p><img src="'+k+`" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>Targeting application(s) based on namespace is generally the most straightforward method of defining a backup policy. However, Kasten also allows you to identify applications based on native Kubernetes labels. This is especially helpful if you want to define &quot;blanket&quot; policies that will apply to current and <em><strong>future</strong></em> applications, such as <code>hasData: true</code> or <code>backup: gold</code>.</p><p>Kasten also provides rich filtering capabilities to include or exclude resources based on Kubernetes <em><strong>API Group</strong></em>, <em><strong>API Version</strong></em>, <em><strong>Resource Type</strong></em>, <em><strong>Resource Name</strong></em>, and <em><strong>Labels</strong></em>. For example, you could exclude backup for <em><strong>Secrets</strong></em> resources where a label includes an indication that the secret is externally managed.</p></div></li><li><p>Leave the remaining settings as default.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p></p><p>When performing many tasks within the Kasten UI, you can press the <em><strong>&lt;/&gt; YAML</strong></em> button to expose the native Kubernetes YAML that defines the resource created through the UI. This can be useful for familiarizing yourself with the Kubernetes-native APIs defined by Kasten and for extracting snippets for use in GitOps or Infrastructure-as-Code tools.</p></div></li><li><p>Click <em><strong>Create Policy</strong></em>.</p></li></ol><h2 id="_5-freezing-the-guest-filesystem" tabindex="-1">5. Freezing the Guest Filesystem <a class="header-anchor" href="#_5-freezing-the-guest-filesystem" aria-label="Permalink to &quot;5. Freezing the Guest Filesystem&quot;">​</a></h2><p>Kasten can freeze the guest filesystem before the snapshot and unfreeze after the snapshot completes by annotating the VirtualMachine resource with <code>k10.kasten.io/freezeVM=true</code>.</p><ol><li><p>In the <em><strong>Web Terminal</strong></em>, enable filesystem freezing for <code>fedora-k10</code>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtualmachine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fedora-k10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kasten-lab</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  k10.kasten.io/freezeVM=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>The freeze and unfreeze operations will only be attempted if the VirtualMachine is in <em><strong>Running</strong></em> state.</p></div><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p></p><p>Kasten defines a 5 minute default timeout for the snapshot operation to complete before aborting the snapshot operation and unfreezing the VM. This can be overridden using the <code>kubeVirtVMs.snapshot.unfreezeTimeout</code> Helm/Operand parameter.</p></div></li></ol><h2 id="_6-running-the-policy" tabindex="-1">6. Running the Policy <a class="header-anchor" href="#_6-running-the-policy" aria-label="Permalink to &quot;6. Running the Policy&quot;">​</a></h2><p>Rather than wait...</p><ol><li><p>In <em><strong>Kasten Dashboard → Policies → Policies</strong></em>, click <em><strong>Run Once</strong></em> for the <code>kasten-lab-backup</code> Policy.</p><p><img src="`+b+'" alt=""></p></li><li><p>Optionally, specify an expiration date for the manual backup and then click <em><strong>Yes, Continue</strong></em> to start the backup.</p><p><img src="'+v+'" alt=""></p></li><li><p>Select <em><strong>Dashboard</strong></em> from the sidebar.</p></li><li><p>Under <em><strong>Actions</strong></em>, select the <code>kasten-lab-backup</code> Policy Run to monitor status.</p><p><img src="'+f+'" alt=""></p><p>Click into each individual <em><strong>Action</strong></em> to view to associated details, including YAML, a complete list of the application metadata and volume snapshots protected, and how much volume data was transferred by the Kasten datamover to the Location Profile.</p><p><img src="'+y+'" alt=""></p></li><li><p>Wait for the <em><strong>Policy Run</strong></em> to complete before proceeding.</p><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p></p><p>If your export failed, ensure you didn&#39;t miss step...</p></div></li></ol><h2 id="_7-performing-a-local-restore" tabindex="-1">7. Performing a Local Restore <a class="header-anchor" href="#_7-performing-a-local-restore" aria-label="Permalink to &quot;7. Performing a Local Restore&quot;">​</a></h2><ol><li><p>In the <em><strong>Kasten Dashboard</strong></em>, select <em><strong>Applications</strong></em> from the sidebar.</p><p>You should observe that the <code>kasten-lab</code> <em><strong>Status</strong></em> has changed to <em><strong>Compliant</strong></em>, indicating that...</p></li><li><p>Under <code>kasten-lab</code>, select <em><strong>... → Restore</strong></em>.</p><p><img src="'+F+'" alt=""></p></li><li><p>Select the most recent RestorePoint, and click the local version as shown below.</p><p><img src="'+C+'" alt=""></p><p>You should observe...</p></li><li><p>Keep the default settings and click <em><strong>Restore</strong></em> to begin a full, in-place restore.</p><p><img src="'+_+'" alt=""></p><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p></p><p>Kasten will terminate the running VM and overwrite the existing resources. However, any resources in the namespace that do not exist in the RestorePoint will not be altered (protecting against unintentional data loss).</p></div></li><li><p>Return to the <em><strong>Dashboard</strong></em> to monitor the status of the <em><strong>Restore</strong></em> under <em><strong>Actions</strong></em>.</p><p>You should expect this operation to complete rapidly, as the VM volume is being restored from a local CSI VolumeSnapshot.</p></li><li><p>Once the <em><strong>Restore</strong></em> has completed, return to <em><strong>OpenShift Console → Virtualization → Virtual Machines</strong></em> and validate the <code>fedora-k10</code> VM is <em><strong>Running</strong></em>.</p><p><img src="'+w+`" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>You can also validate the source of the restored volume by running:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> describe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pvc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fedora-k10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kasten-lab</span></span></code></pre></div><p>You should observe the volume&#39;s <em><strong>DataSource</strong></em> is a <code>k10-csi-snap-...</code> VolumeSnapshot.</p></div></li></ol><h2 id="_8-performing-a-remote-restore" tabindex="-1">8. Performing a Remote Restore <a class="header-anchor" href="#_8-performing-a-remote-restore" aria-label="Permalink to &quot;8. Performing a Remote Restore&quot;">​</a></h2><ol><li><p>In the <em><strong>Web Terminal</strong></em>, run the following to delete the <code>kasten-lab</code> namespace:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtualmachine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fedora-k10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kasten-lab</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kasten-lab</span></span></code></pre></div><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p></p><p><em>&quot;Snapshots are not backup.&quot;</em> ~ Mark Twain</p><p>VolumeSnapshots are namespaced resources. Removing the <code>kasten-lab</code> namespace will delete the VolumeSnapshots associated with your local RestorePoints. Additionally, the <code>ocs-storagecluster-rbdplugin-snapclass</code> VolumeSnapshotClass sets <code>deletionPolicy: Delete</code> by default, meaning that deletion of the VolumeSnapshot resource results in the removal of the snapshot within Ceph.</p></div></li><li><p>In the <em><strong>Kasten Dashboard</strong></em>, select <em><strong>Applications</strong></em> from the sidebar.</p></li><li><p>Click the <em><strong>All</strong></em> dropdown menu and select <em><strong>Removed</strong></em> to view the list of non-existent namespaces with available RestorePoints.</p><p><img src="`+B+'" alt=""></p></li><li><p>Under <code>kasten-lab</code>, select <em><strong>... → Restore</strong></em>.</p></li><li><p>Select the most recent RestorePoint, and click the <em><strong>EXPORTED</strong></em> version as shown below.</p><p><img src="'+P+'" alt=""></p></li><li><p>Under <em><strong>Application Name</strong></em>, click <em><strong>+ Create New Namespace</strong></em>.</p></li><li><p>Specify <code>kasten-lab-clone</code> as the <em><strong>New Namespace</strong></em> and click <em><strong>Create</strong></em>.</p><p><img src="'+E+'" alt=""></p></li><li><p>Click <em><strong>Restore</strong></em> and return to the <em><strong>Dashboard</strong></em> to monitor progress under <em><strong>Actions</strong></em>.</p><p><img src="'+T+'" alt=""></p></li><li><p>Return to <em><strong>OpenShift Console → Virtualization → VirtualMachines</strong></em> and observe the <code>fedora-k10</code> VirtualMachine now running in the <code>kasten-lab-clone</code> namespace.</p><p><img src="'+x+'" alt=""></p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p></p><p>Unlike the local restore, the PVC populated by the Kasten datamover will not contain a <em><strong>DataSource</strong></em> snapshot reference:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">oc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> describe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pvc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fedora-k10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kasten-lab-clone</span></span></code></pre></div></div></li></ol><h2 id="_9-takeaways" tabindex="-1">9. Takeaways <a class="header-anchor" href="#_9-takeaways" aria-label="Permalink to &quot;9. Takeaways&quot;">​</a></h2><ul><li>Stuff</li><li>And</li><li>Things</li></ul>',22),V=[A];function S(M,I,N,q,K,O){return s(),t("div",null,V)}const L=e(R,[["render",S]]);export{z as __pageData,L as default};
